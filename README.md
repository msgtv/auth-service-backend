# Сервис авторизации на FastAPI

Проект включает модульную архитектуру, поддерживает гибкое логирование с **loguru**, и взаимодействие с базой данных через **SQLAlchemy** с асинхронной поддержкой. Система миграций **Alembic** упрощает работу со схемой базы данных. Дополнительно реализована административная панель на **SQLAdmin** с защищенным доступом.

## Стек технологий

- **Веб-фреймворк**: FastAPI
- **ORM**: SQLAlchemy с асинхронной поддержкой через asyncpg
- **База данных**: PostgreSQL
- **Система миграций**: Alembic
- **Авторизация/Аутентификация**: bcrypt для хеширования паролей, python-jose для защиты данных с использованием JWT
- **Административная панель**: SQLAdmin для управления данными через веб-интерфейс
- **Логирование**: loguru для структурированного и настраиваемого логирования
- **Контейнеризация**: Docker и docker-compose для развертывания
- **Веб-сервер**: Nginx в качестве обратного прокси

## Зависимости проекта

- `fastapi[all]==0.115.0` - высокопроизводительный веб-фреймворк
- `pydantic==2.9.2` - валидация данных
- `pydantic[email]` - поддержка валидации email-адресов
- `uvicorn==0.31.0` - ASGI-сервер
- `jinja2==3.1.6` - шаблонизатор
- `pydantic_settings==2.5.2` - управление настройками приложения
- `asyncpg==0.30.0` - асинхронная поддержка PostgreSQL
- `alembic==1.13.3` - управление миграциями базы данных
- `SQLAlchemy==2.0.35` - ORM для работы с базами данных
- `bcrypt==4.0.1` и `passlib[bcrypt]==1.7.4` - хеширование паролей
- `python-jose==3.4.0` - работа с JWT токенами
- `loguru==0.7.2` - красивое и удобное логирование
- `sqladmin==0.20.1` - административная панель для SQLAlchemy моделей

## Структура проекта

Проект построен с учётом модульной архитектуры, что позволяет легко расширять приложение и упрощает его поддержку.
Каждый модуль отвечает за отдельные задачи, такие как авторизация или управление данными.

### Основная структура проекта

```
├── app/
│   ├── admin/                   # Административная панель
│   │   ├── auth.py              # Аутентификация для админ-панели
│   │   ├── role.py              # Управление ролями
│   │   ├── user.py              # Управление пользователями
│   ├── auth/                    # Модуль авторизации и аутентификации
│   │   ├── dao.py               # Data Access Object для работы с БД
│   │   ├── models.py            # Модели данных для авторизации
│   │   ├── router.py            # Роутеры FastAPI для маршрутизации
│   │   ├── schemas.py           # Схемы для валидации данных
│   │   └── utils.py             # Вспомогательные функции для авторизации
│   ├── dao/                     # Общие DAO для приложения
│   │   ├── database.py          # Подключение к базе данных и управление сессиями
│   │   └── base.py              # Базовый класс DAO для работы с БД
│   ├── dependencies             # Зависимости в проекте
│   │   ├── auth_dep.py          # Зависимости для авторизации
│   │   └── dao_dep.py           # Зависимости для сессий SQLAlchemy
│   ├── migration/               # Миграции базы данных
│   │   ├── versions/            # Файлы миграций
│   │   ├── env.py               # Настройки среды для Alembic
│   │   ├── README               # Документация по миграциям
│   │   └── script.py.mako       # Шаблон для генерации миграций
│   ├── static/                  # Статические файлы приложения
│   │   └── .gitkeep             # Пустой файл для сохранения папки в Git
│   ├── config.py                # Конфигурация приложения
│   ├── exceptions.py            # Исключения для обработки ошибок
│   ├── main.py                  # Основной файл для запуска приложения
├── configs/                     # Конфигурации для внешних сервисов
│   └── nginx.conf               # Конфигурация Nginx
├── Dockerfile                   # Описание Docker образа
├── docker-compose.yaml          # Конфигурация для Docker Compose
├── .env                         # Конфигурация окружения
├── alembic.ini                  # Конфигурация Alembic
├── README.md                    # Документация проекта
└── requirements.txt             # Зависимости проекта
```

## Основные модули

### **app/admin** - Административная панель

Модуль предоставляет веб-интерфейс для управления данными приложения через SQLAdmin:

- **`auth.py`**: Реализация аутентификации для административной панели с использованием JWT токенов.
- **`role.py`**: Управление ролями пользователей в системе через административный интерфейс.
- **`user.py`**: Интерфейс администрирования пользователей системы.

### **app/auth** - Модуль для аутентификации и авторизации

Модуль отвечает за управление процессами аутентификации (входа пользователей) и авторизации (проверки доступа).  
Основные файлы:

- **`dao.py`**: Объект доступа к данным пользователей. Содержит методы для работы с базой данных (создание, обновление, поиск пользователей и т. д.).
- **`models.py`**: Определяет ORM-модели данных для пользователей и ролей в системе.
- **`router.py`**: Роутер для маршрутизации запросов, связанных с аутентификацией. Определяет эндпоинты для входа, регистрации и проверки доступа.
- **`schemas.py`**: Определяет Pydantic-схемы для валидации входных данных и структуры ответов.
- **`utils.py`**: Вспомогательные функции для работы с токенами (создание, проверка JWT) и шифрование паролей.

### **app/dao** - Базовый слой доступа к данным (Data Access Layer)

Модуль содержит абстракции для работы с базой данных. Используется для управления подключениями и реализации CRUD-операций.

- **`base.py`**: Базовый класс DAO, предоставляющий общие методы для работы с базой данных, такие как добавление, обновление, удаление и поиск записей.
- **`database.py`**: Отвечает за подключение к базе данных, управление сессиями SQLAlchemy и определение базового класса для моделей.

### **app/dependencies** - Управление зависимостями FastAPI

Модуль содержит зависимости, которые используются в проекте.

- **`auth_dep.py`**: Зависимости, связанные с авторизацией пользователя в системе, включая проверку прав доступа для различных ролей.
- **`dao_dep.py`**: Зависимости, связанные с управлением сессией SQLAlchemy.

### **app/migration** - Управление миграциями базы данных с Alembic

Модуль упрощает управление схемой базы данных и позволяет безопасно вносить изменения.

- **`versions/`**: Хранятся файлы миграций, автоматически создаваемые Alembic.
- **`env.py`**: Основной файл конфигурации для Alembic, определяет подключение к базе данных и взаимодействие с ORM.
- **`script.py.mako`**: Шаблон для генерации новых файлов миграций.

### **config.py** - Настройки и конфигурация приложения

- Определяет параметры приложения, загружаемые из файла `.env`. Например:
  - `SECRET_KEY`: Секретный ключ для подписания JWT.
  - `ALGORITHM`: Алгоритм хеширования токенов.
  - `DATABASE_URL`: URL для подключения к базе данных.
- Обеспечивает удобное управление конфигурацией для разных окружений.

### **main.py** - Основной файл для запуска приложения

- **Инициализация приложения**: Настраивает FastAPI-приложение, включая параметры, такие как название, версия, и описание.
- **Подключение роутеров**: Регистрирует маршруты, определённые в модулях приложения.
- **Настройка зависимостей**: Внедряет глобальные зависимости.
- **Интеграция административной панели**: Настраивает SQLAdmin для управления данными через веб-интерфейс.

## Настройка аутентификации и авторизации

Для аутентификации используется JSON Web Token (JWT) с bcrypt для хеширования паролей и python-jose для генерации и проверки токенов. Это обеспечивает безопасное хранение данных и защищает API-эндпоинты.

Система поддерживает следующие роли пользователей:
- Обычный пользователь
- Администратор
- Суперадминистратор

## Административная панель

Проект включает административную панель на базе SQLAdmin для удобного управления данными:

1. Доступ к панели осуществляется через `/admin` по умолчанию
2. Аутентификация в административной панели интегрирована с основной системой авторизации
3. Панель предоставляет интерфейс для управления пользователями и ролями

## Запуск приложения

### Стандартный запуск

1. Клонируйте репозиторий:

   ```bash
   git clone https://github.com/Yakvenalex/FastApiWithAuthSample.git .
   ```

2. Установите зависимости:

   ```bash
   pip install -r requirements.txt
   ```

3. Создайте и настройте `.env` файл:

   ```env
   SECRET_KEY=supersecretkey
   ALGORITHM=HS256
   
   POSTGRES_USER=postgres
   POSTGRES_PASSWORD=postgres
   POSTGRES_DB=auth_db
   POSTGRES_HOST=localhost
   POSTGRES_PORT=5432
   
   TEST_POSTGRES_USER=postgres
   TEST_POSTGRES_PASSWORD=postgres
   TEST_POSTGRES_DB=auth_test_db
   TEST_POSTGRES_HOST=localhost
   TEST_POSTGRES_PORT=5432
   ```

4. Запустите приложение с Uvicorn:

   ```bash
   uvicorn app.main:app --reload --port 8000
   ```

### Запуск с Docker Compose

1. Создайте и настройте `.env` файл (как указано выше, но с `POSTGRES_HOST=db`)

2. Запустите контейнеры:

   ```bash
   docker-compose up -d
   ```

3. Приложение будет доступно на порту 80 (или согласно настройкам в `docker-compose.yaml`)

## Миграции базы данных

1. Инициализируйте миграции (если запускаете проект впервые):

   ```bash
   alembic upgrade head
   ```

2. Создайте новую миграцию после изменения моделей:

   ```bash
   alembic revision --autogenerate -m "Описание изменений"
   ```

3. Примените миграции:

   ```bash
   alembic upgrade head
   ```

## API эндпоинты

Основные API эндпоинты для работы с аутентификацией:

- **POST /auth/register/** - Регистрация нового пользователя
- **POST /auth/login/** - Вход в систему
- **POST /auth/logout** - Выход из системы
- **GET /auth/me/** - Получение информации о текущем пользователе
- **GET /auth/all_users/** - Получение списка всех пользователей (только для администраторов)
- **POST /auth/refresh** - Обновление токенов доступа

## Лучшие практики

- Разделяйте функциональность приложения на модули для удобства тестирования и поддержки.
- Обрабатывайте ошибки с четкими ответами и HTTP-кодами.
- Проводите миграции с Alembic для управления схемой базы данных.
- Используйте переменные окружения для безопасного хранения конфиденциальных данных.
- Применяйте ролевую модель для разграничения прав доступа пользователей.
- Используйте Docker для стандартизации окружения разработки и развертывания.

## Дополнительные ресурсы

- [Документация FastAPI](https://fastapi.tiangolo.com/) - официальная документация FastAPI
- [SQLAlchemy документация](https://docs.sqlalchemy.org/) - документация по ORM
- [Alembic документация](https://alembic.sqlalchemy.org/) - документация по системе миграций
- [SQLAdmin документация](https://aminalaee.dev/sqladmin/) - документация административной панели
